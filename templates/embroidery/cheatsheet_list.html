{% extends "embroidery/customer_base.html" %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cheatsheet Downloads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body {
      background: #f8f9fa;
      font-family: "Poppins", sans-serif;
    }
    .table-container {
      max-width: 900px;
      margin: 50px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 600;
      color: #333;
    }
    .btn-download {
      background-color: #28a745;
      color: white;
      border-radius: 5px;
      padding: 6px 12px;
      font-size: 14px;
      margin-right: 5px;
    }
    .btn-download:hover {
      background-color: #218838;
    }
    .btn-pay {
      background-color: #ffc107;
      color: #212529;
      border-radius: 5px;
      padding: 6px 12px;
      font-size: 14px;
      margin-right: 5px;
    }
    .btn-pay:hover {
      background-color: #e0a800;
    }
    .btn-preview {
      background-color: #6c757d;
      color: white;
      border-radius: 5px;
      padding: 6px 12px;
      font-size: 14px;
    }
    .btn-preview:hover {
      background-color: #5a6268;
    }
  </style>
</head>
<body>
  <div class="table-container">
    <h2>Available Cheatsheets</h2>
    <table class="table table-striped">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Stitches</th>
          <th>Turnaround</th>
          <th>Price (â‚¹)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for file in files %}
        <tr>
          <td>{{ file.title }}</td>
          <td>{{ file.stitch_count }}</td>
          <td>{{ file.turnaround }}</td>
          <td>{{ file.price }}</td>
          <td>
            {% if file.is_paid %}
              <a href="{% url 'download_file' file.id %}" class="btn btn-download">Download</a>
            {% else %}
              <button class="btn btn-pay pay-btn" data-file-id="{{ file.id }}">Pay to Download</button>
            {% endif %}
            <a href="{% url 'preview_file' file.id %}" target="_blank" class="btn btn-preview">Preview</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center">No cheatsheets available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".pay-btn").forEach(button => {
      button.addEventListener("click", function () {
        const fileId = this.dataset.fileId;
        fetch("{% url 'create_order' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: new URLSearchParams({ file_id: fileId })
        })
        .then(res => res.json())
        .then(order => {
          if (order.error) {
            alert("Error: " + order.error);
            return;
          }
          const options = {
            key: "{{ razorpay_key }}",
            amount: order.amount,
            currency: order.currency,
            name: "Universe Digitizing",
            description: "Cheatsheet Download",
            order_id: order.id,
            handler: function (response) {
              verifyPayment(response, fileId);
            },
            prefill: { email: "{{ request.user.email|default:'' }}" },
            theme: { color: "#28a745" }
          };
          new Razorpay(options).open();
        })
        .catch(err => {
          console.error(err);
          alert("Could not create order. Try again.");
        });
      });
    });
  });

  function verifyPayment(response, fileId) {
    fetch("{% url 'verify_payment' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        razorpay_order_id: response.razorpay_order_id,
        razorpay_payment_id: response.razorpay_payment_id,
        razorpay_signature: response.razorpay_signature,
        file_id: fileId
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "Payment Verified and Saved") {
        alert("Payment successful! Redirecting to download.");
        window.location.href = "{% url 'download_file' 0 %}".replace('/0/', '/' + fileId + '/');
      } else {
        alert("Verification failed: " + (data.error || data.status));
      }
    })
    .catch(err => {
      console.error(err);
      alert("Error verifying payment.");
    });
  }
  </script>
</body>
</html>
{% endblock %}
